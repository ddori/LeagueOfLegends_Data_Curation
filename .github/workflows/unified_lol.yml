name: LoL Unified Pipeline

on:
  workflow_dispatch:
    inputs:
      riot_api_key:
        description: "Riot API key"
        required: true
        type: string
      patch_mm:
        description: "Patch prefix for SoloQ (e.g., 15.24)"
        required: true
        default: "15.24"
        type: string
      pro_gdrive_url:
        description: "Google Drive link for Pro CSV (view link OK)"
        required: true
        type: string

jobs:
  soloq-acquire:
    runs-on: ubuntu-latest

    env:
      RIOT_API_KEY: ${{ inputs.riot_api_key }}
      PATCH_MM: ${{ inputs.patch_mm }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run SoloQ acquire
        working-directory: SoloQ
        run: |
          echo "[Run] SoloQ acquire with PATCH_MM=${PATCH_MM}"
          python acquire.py

      - uses: actions/upload-artifact@v4
        with:
          name: soloq-raw-${{ inputs.patch_mm }}
          path: SoloQ/output_*_by_tier
          retention-days: 7

  soloq-parse:
    runs-on: ubuntu-latest
    needs: soloq-acquire

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: soloq-raw-${{ inputs.patch_mm }}
          path: SoloQ

      - name: Run SoloQ parse
        working-directory: SoloQ
        run: |
          python parse.py

      - uses: actions/upload-artifact@v4
        with:
          name: soloq-parsed-${{ inputs.patch_mm }}
          path: |
            SoloQ/data/soloq_full_*.csv
            SoloQ/data/soloq_full_*.parquet
          retention-days: 7

  soloq-clean:
    runs-on: ubuntu-latest
    needs: soloq-parse

    env:
      PATCH_MM: ${{ inputs.patch_mm }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: soloq-parsed-${{ inputs.patch_mm }}
          path: SoloQ/data

      - name: Run SoloQ clean
        working-directory: SoloQ
        run: |
          python clean.py

      - uses: actions/upload-artifact@v4
        with:
          name: soloq-clean-${{ inputs.patch_mm }}
          path: SoloQ/data/soloq_clean_*.csv
          retention-days: 7

    pro-download-clean:
    runs-on: ubuntu-latest

    env:
      PRO_GDRIVE_URL: ${{ inputs.pro_gdrive_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install gdown and deps
        run: |
          python -m pip install --upgrade pip
          pip install gdown -r requirements.txt

      - name: Download Pro CSV from Google Drive
        run: |
          mkdir -p pro/data
          echo "[Run] Downloading Pro CSV from ${PRO_GDRIVE_URL}"
          # clean.py가 기대하는 EXACT 경로/파일명으로 저장
          gdown --fuzzy "${PRO_GDRIVE_URL}" \
            -O pro/data/2025_LoL_esports_match_data_from_OraclesElixir.csv
          echo "==== ls pro/data ===="
          ls -al pro/data
          echo "==== head ===="
          head -n 5 pro/data/2025_LoL_esports_match_data_from_OraclesElixir.csv || true

      - name: Validate Pro CSV header
        run: |
          FILE=pro/data/2025_LoL_esports_match_data_from_OraclesElixir.csv
          echo "[Validate] Checking if file looks like CSV: $FILE"
          if grep -qi "<html" "$FILE"; then
            echo "::error::Downloaded file is HTML instead of CSV"
            head -n 20 "$FILE" || true
            exit 1
          fi
          # Oracle's Elixir 헤더 체크 (gameid, league 등)
          if head -n 1 "$FILE" | grep -q -E "gameid,.*league,.*year"; then
            echo "[OK] CSV header valid"
          else
            echo "::error::CSV header looks invalid"
            head -n 5 "$FILE"
            exit 1
          fi

      - name: Run Pro clean
        working-directory: pro
        run: |
          echo "[Run] Pro clean"
          # clean.py 안에서 RAW_PATH = "./data/2025_LoL_esports_match_data_from_OraclesElixir.csv" 사용
          python clean.py

      - name: Upload cleaned Pro
        uses: actions/upload-artifact@v4
        with:
          name: pro-clean-2025
          path: pro/data/pro_2025_cleaned.csv
          retention-days: 7

  unify:
    runs-on: ubuntu-latest
    needs:
      - soloq-clean
      - pro-download-clean

    env:
      PATCH_MM: ${{ inputs.patch_mm }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: soloq-clean-${{ inputs.patch_mm }}
          path: SoloQ/data

      - uses: actions/download-artifact@v4
        with:
          name: pro-clean-2025
          path: pro/data

      - name: Run unified builder
        run: |
          python unified.py

      - uses: actions/upload-artifact@v4
        with:
          name: unified-${{ inputs.patch_mm }}
          path: unified_pro_soloq_with_metrics.csv
          retention-days: 14

  app-check:
    runs-on: ubuntu-latest
    needs: unify

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt streamlit

      - uses: actions/download-artifact@v4
        with:
          name: unified-${{ inputs.patch_mm }}
          path: .

      - name: Sanity check app.py
        run: |
          python -m py_compile app.py
